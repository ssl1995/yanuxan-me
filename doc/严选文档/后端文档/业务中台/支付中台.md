# 支付中台设计文档

### 支付中台背景

1. 很多业务系统都有支付需求，比如学习平台卖课程、严选商城卖商品、枫叶云笔记开通VIP等。
2. 维护难：不同的业务系统可能有不同的开发人员，不同的对接方式，不同的对接组件。
3. 扩展难：不利于支付通道和支付方式扩展，需要单独为业务系统编写代码。
4. 调试难：不同应用、不同支付环境下都需要单独调试。

### 产品形态

1. 对接多支付渠道（支付宝、微信）
2. 对接多支付方式、H5、PC、扫码支付等）
3. 聚合支付收银台，统一网页支付
4. 外部接入便捷，内部扩展灵活
5. 数据安全、高可用部署
6. 数据统计、分析...

### 产品优点

1. 与业务解耦，功能简单精准，管理平台操作界面简洁、清晰、易用
2. 支持服务之间的接口、HTTP形式接口调用
3. 分布式部署，动态扩容服务节点，保障高并发高可用性
4. 接口请求和响应数据采用签名机制，保证交易数据安全性
5. 异步延时通知业务系统，支持MQ消息和HTTP接口，保障数据稳定性

### 问题及解决方案

##### Q：如何保障数据对接安全？

* 对内与对外暴露的接口，都需要使用支付应用的签名秘钥对参数进行MD5签名，只有签名校验通过，才能成功调用接口。
* 业务系统接收来自支付中台的消息通知，也需要对参数进行MD5签名，通过对比签名是否一致，杜绝虚假通知，保障数据安全。

##### Q：如何在容器内保存证书资料？

* 容器化部署具有无状态、动态伸缩扩容的特点，无法像传统服务器一样将文件存放在本地目录中。
* 证书资料具有高度保密性，因此将证书文件上传到阿里云OSS的私有bucket桶中，不允许公开访问，且上传成功对所有关键信息脱敏，保护资料安全。
* 容器成功后，主动从阿里云OSS下载证书资料文件存放在容器内使用。

##### Q：多节点之间证书如何同步？

* 当证书资料发送变更时，接收变更请求的节点向RocketMQ发送广播消息，接收到广播消息的节点，触发执行从OSS下载最新证书。

##### Q：如何提高业务系统接收通知的成功率？

* 只有接收到来自业务系统明确的反馈，才表示通知消息被成功消费。
* 采用MQ延时消息通知策略，按照一定的策略组合(10s/30s/1m/5m/30/1h/2h)，对业务系统重复发送通知，尽可能的提高通知成功率。

##### Q：证书同步失败怎么办？

* 服务节点下载证书后，读取文件二进制，并对内容取MD5值，存放在本地缓存（Map）。
* 上传证书文件时，对文件内容取MD5值，保存到数据库或全局缓存中，每次使用证书前对比证书MD5值，不一致则主动更新证书文件。

### 架构图

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/383/1657801710063/7cda1082a9944a02bc3364317bad22a8.png)

### 支付流程图

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/383/1657801710063/d6152e2df11c4cffa42640083567dd49.png)

### 退款流程图

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/383/1657801710063/87dd73f119b9425494f091761b3c247f.png)

### 类图

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/383/1657801710063/6179c0544f3e4ff6b6955003a40d08df.png)